<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="ClipSage"
           Version="$(var.Version)"
           Manufacturer="ClipSage"
           UpgradeCode="6fe30b47-2626-43ff-9384-d324f425a2a2"
           InstallerVersion="200">

    <SummaryInformation Description="ClipSage Installer" />

    <Media Id="1" Cabinet="product.cab" EmbedCab="yes" CompressionLevel="high" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch ClipSage when setup exits" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WixShellExecTarget" Value="[#ClipSageExe]" />
    <Property Id="STARTUPCHECKBOX" Value="1" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Start ClipSage automatically when you log in to Windows" />

    <CustomAction Id="LaunchApplication"
                  BinaryKey="WixCA"
                  DllEntry="WixShellExec"
                  Impersonate="yes" />

    <InstallExecuteSequence>
      <Custom Action="LaunchApplication" After="InstallFinalize">
        WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 AND NOT Installed
      </Custom>
    </InstallExecuteSequence>

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="COMPANYFOLDER" Name="ClipSage">
        <Directory Id="INSTALLFOLDER" Name="ClipSage">
          <Component Id="MainExecutable" Guid="*">
            <File Id="ClipSageExe" Source="$(var.PublishDir)\ClipSage.App.exe" KeyPath="yes">
              <Shortcut Id="startmenuShortcut"
                        Directory="ProgramMenuFolder"
                        Name="ClipSage"
                        WorkingDirectory="INSTALLFOLDER"
                        Advertise="yes" />
              <Shortcut Id="desktopShortcut"
                        Directory="DesktopFolder"
                        Name="ClipSage"
                        WorkingDirectory="INSTALLFOLDER"
                        Advertise="yes" />
            </File>
          </Component>

          <!-- Registry entry for auto-start -->
          <Component Id="RegistryEntries" Guid="*">
            <Condition>STARTUPCHECKBOX = 1</Condition>
            <RegistryValue Root="HKCU"
                           Key="Software\Microsoft\Windows\CurrentVersion\Run"
                           Name="ClipSage"
                           Value="&quot;[INSTALLFOLDER]ClipSage.App.exe&quot;"
                           Type="string"
                           KeyPath="yes" />
          </Component>
        </Directory>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder" />
    <StandardDirectory Id="DesktopFolder" />

    <Feature Id="ProductFeature" Title="ClipSage" Level="1">
      <ComponentGroupRef Id="PublishedComponents" />
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="RegistryEntries" />
    </Feature>

    <ui:WixUI Id="WixUI_InstallDir" />
  </Package>
</Wix>
