<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="ClipSage"
           Version="1.0.13"
           Manufacturer="ClipSage"
           UpgradeCode="6fe30b47-2626-43ff-9384-d324f425a2a2"
           InstallerVersion="200">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Properties for UI customization -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch ClipSage when setup exits" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="STARTUPCHECKBOX" Value="1" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Start ClipSage automatically when you log in to Windows" />
    <Property Id="WixShellExecTarget" Value="[#ClipSageExe]" />

    <!-- Custom action to launch the application after installation -->
    <CustomAction Id="LaunchApplication" 
                  BinaryKey="WixCA" 
                  DllEntry="WixShellExec" 
                  Impersonate="yes" />

    <!-- Execute the custom action after installation if the checkbox is checked -->
    <InstallExecuteSequence>
      <Custom Action="LaunchApplication" After="InstallFinalize">
        WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 AND NOT Installed
      </Custom>
    </InstallExecuteSequence>

    <!-- Define the directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="ClipSage">
        <!-- Main application component -->
        <Component Id="MainExecutable" Guid="*">
          <File Id="ClipSageExe" Source="bin\ClipSage-1.0.13\ClipSage.App.exe" KeyPath="yes" />
          <!-- Add other files here -->
        </Component>
        
        <!-- Registry entry for auto-start -->
        <Component Id="AutoStartRegistry" Guid="*">
          <Condition>STARTUPCHECKBOX = 1</Condition>
          <RegistryValue Root="HKCU" 
                         Key="Software\Microsoft\Windows\CurrentVersion\Run" 
                         Name="ClipSage" 
                         Value="&quot;[INSTALLFOLDER]ClipSage.App.exe&quot;" 
                         Type="string" 
                         KeyPath="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <!-- Define program menu and desktop shortcuts -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="ClipSage">
        <Component Id="ApplicationShortcut" Guid="*">
          <Shortcut Id="ApplicationStartMenuShortcut" 
                    Name="ClipSage" 
                    Description="ClipSage Clipboard Manager"
                    Target="[INSTALLFOLDER]ClipSage.App.exe"
                    WorkingDirectory="INSTALLFOLDER"/>
          <RemoveFolder Id="RemoveApplicationProgramsFolder" On="uninstall"/>
          <RegistryValue Root="HKCU" Key="Software\ClipSage" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
        </Component>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder">
      <Component Id="ApplicationShortcutDesktop" Guid="*">
        <Shortcut Id="ApplicationDesktopShortcut" 
                  Name="ClipSage" 
                  Description="ClipSage Clipboard Manager"
                  Target="[INSTALLFOLDER]ClipSage.App.exe"
                  WorkingDirectory="INSTALLFOLDER"/>
        <RegistryValue Root="HKCU" Key="Software\ClipSage" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </StandardDirectory>

    <!-- Define the features to install -->
    <Feature Id="ProductFeature" Title="ClipSage" Level="1">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="ApplicationShortcutDesktop" />
      <ComponentRef Id="AutoStartRegistry" />
    </Feature>

    <!-- Use the WixUI_InstallDir dialog set -->
    <ui:WixUI Id="WixUI_InstallDir" />
  </Package>
</Wix>
